<!DOCTYPE html>
<title>Fnord Foundation - SHV/BOS covid visualizations</title>
<style>
    body {
        background-color: #eee;
    }
    div#main {
        display: flex;
    }
    div#main div {
        width: 100%;
    }
    .flex {
        display: flex;
    }
    .column {
        flex-direction: column;
    }
    @media only screen and (max-width: 720px) {
        div#main {
            flex-direction: column;
        }
    }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<body class="flex column">
    <div id="opener">
        <p>Tracking covid-19 trends in Caddo and Bossier Parishes.</p>
    </div>
    <div id="descriptive-stats" class="flex">
        <div id="caddo-descriptive"></div>
        <div id="bossier-descriptive"></div>
    </div>
    <div id="controls">
        Select a visualization to view:
        <select>
            <option value="">Select...</option>
            <option value="percapitadailycases">Per capita daily cases</option>
            <option value="percapitadailytests">Per capita daily tests</option>
        </select>
    </div>
    <div id="main">
        <div id="caddo"></div>
        <div id="bossier"></div>
    </div>
    <div>
        <p>A project by <a href="http://portfolio.fnord.foundation">Fnord Foundation</a>.</p>
        <p>Sources: </p>
        <ul>
            <li><a href="https://ldh.la.gov/Coronavirus/">Louisiana Department of Health</a></li>
            <li><a href="https://www.census.gov/data/datasets/time-series/demo/popest/2010s-counties-total.html">United States Census</a></li>
        </ul>
    </div>
</body>
<script src="scripts/d3.js"></script>
<script>
async function descriptiveStats(parish) {
    let data = await fetch(`data/${parish}Descrip.json`).then(resp=>resp.json());
    let container = document.createElement('div');
    let table = document.createElement('table');
    // some people say this approach is gauche but I'm just vibing
    table.innerHTML = `
    <tr><th>${parish.substr(0,1).toUpperCase() + parish.substr(1)} at a glance...</th></tr>
    <tr><td>Total Tests</td><td>${data['Total Tests']}</td></tr>
    <tr><td>Total Cases</td><td>${data['Total Cases']}</td></tr>
    <tr><td>Latest Data</td><td>${data['Latest Data']}</td></tr>
    `;
    container.appendChild(table);
    return container;
}
async function dailyPerCapitaTestCount(parish, targetSelector) {
    // remove any pre-existing graphs
    let target = document.querySelector(targetSelector);
    target.remove();
    let newDiv = document.createElement('div');
    newDiv.id = parish;
    let main = document.querySelector('#main');
    main.appendChild(newDiv);

    let header = document.createElement('h3');
    header.innerText = `${parish.substr(0,1).toUpperCase() + parish.substr(1)} Parish Covid-19 daily tests per capita`;
    document.querySelector(targetSelector)
            .appendChild(header);

    const CADDO_POP_2019 = 240204;
    let data = await fetch(`${parish}.json`).then(resp=>resp.json());

    let margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = document.querySelector(targetSelector).offsetWidth - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    let svg = d3.select(targetSelector)
        .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
        .append('g')
            .attr('transform',
                  `translate(${margin.left}, ${margin.top})`);
        
    data.forEach((d,i)=>{
                // we need to strip the last three 0's from Lab Collection Date or we get weird numbers
                d['Lab Collection Date'] = d3.timeParse('%s')(String(d['Lab Collection Date']).slice(0, -3));
                data[i] = d;
            })
            
    let x = d3.scaleTime()
        .domain(d3.extent(data, d=>d['Lab Collection Date']))
        .range([0, width]);
    
    svg.append('g')
        .attr('transform', `translate(0, ${height})`)
        .call(d3.axisBottom(x));
    
    let y = d3.scaleLinear()
            .domain([0, d3.max(data, d=>d['Daily Test Count']/CADDO_POP_2019)])
            .range([height, 0])

    svg.append('g')
        .call(d3.axisLeft(y));

    // append the line
    svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#222')
                .attr('stroke-width', 1.5)
                .attr('d', d3.line()
                    .x(d=>x(d['Lab Collection Date']))
                    .y(d=>y(d['Daily Test Count']/CADDO_POP_2019))
                )
                
}
async function dailyPerCapitaCaseCount(parish, targetSelector) {
    // remove any pre-existing graphs
    let target = document.querySelector(targetSelector);
    target.remove();
    let newDiv = document.createElement('div');
    newDiv.id = parish;
    let main = document.querySelector('#main');
    main.appendChild(newDiv);

    const BOSSIER_POP_2019 = 127039;
    const CADDO_POP_2019 = 240204;

    let margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = document.querySelector(targetSelector).offsetWidth - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    let header = document.createElement('h3');
    header.innerText = `${parish.substr(0,1).toUpperCase() + parish.substr(1)} Parish Covid-19 daily cases per capita`;
    document.querySelector(targetSelector)
            .appendChild(header);

    let svg = d3.select(targetSelector)
        .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
        .append('g')
            .attr('transform',
                  `translate(${margin.left}, ${margin.top})`);

    let data = await fetch(`${parish}.json`).then(resp=>resp.json());

    data.forEach((d,i)=>{
                // we need to strip the last three 0's from Lab Collection Date or we get weird numbers
                d['Lab Collection Date'] = d3.timeParse('%s')(String(d['Lab Collection Date']).slice(0, -3));
                data[i] = d;
            })
            
    let x = d3.scaleTime()
        .domain(d3.extent(data, d=>d['Lab Collection Date']))
        .range([0, width]);
    
    svg.append('g')
        .attr('transform', `translate(0, ${height})`)
        .call(d3.axisBottom(x));
    
    let population = parish === 'caddo' ? CADDO_POP_2019 : BOSSIER_POP_2019;

    // user Bossier's max as a basis for both caddo and bossier since it's higher and gives us a uniform axis for easier comparison
    let yMax = [0, d3.max(await fetch('bossier.json').then(d=>d.json()), d=>d['Daily Case Count']/BOSSIER_POP_2019)];
    let y = d3.scaleLinear()
            // .domain([0, d3.max(data, d=>d['Daily Case Count']/population)])
            .domain(yMax)
            .range([height, 0])

    svg.append('g')
        .call(d3.axisLeft(y));

    // append the line
    svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#222')
                .attr('stroke-width', 1.5)
                .attr('d', d3.line()
                    .x(d=>x(d['Lab Collection Date']))
                    .y(d=>y(d['Daily Case Count']/population))
                )
}

(async ()=>{
    // assign onchange to select
    let select = document.querySelector('select');
    let caddo = document.querySelector('#caddo-descriptive');
    caddo.appendChild(await descriptiveStats('caddo'))
    let bossier = document.querySelector('#bossier-descriptive');
    bossier.appendChild(await descriptiveStats('bossier'))
    select.onchange = (e) => {
        let target = e.target;
        switch (target.value) {
            case "percapitadailycases":
                // remove the current graph
                dailyPerCapitaCaseCount('caddo', '#caddo');
                dailyPerCapitaCaseCount('bossier', '#bossier');
                break;
            case "percapitadailytests":
                dailyPerCapitaTestCount('caddo', '#caddo');
                dailyPerCapitaTestCount('bossier', '#bossier');
                break;
        }
    }
})()

/*
(async ()=>{
    const BOSSIER_POP_2019 = 127039;
    const CADDO_POP_2019 = 240204;

    let margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = document.querySelector('#caddo').offsetWidth - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;


    // grab bossier's data so we can get yStandard
    let bossierData = async ()=>{
        return d3.max(await fetch('bossier.json').then(data=>data.json()), d=>d['Daily Case Count']/BOSSIER_POP_2019);
    } 
    let yStandard = [0, await bossierData()];
    console.log(yStandard);
    
    let header = document.createElement('h3');
    header.innerText = "Bossier Parish Covid-19 daily cases per capita";
    document.querySelector('#bossier')
            .appendChild(header);

    const bossierSvg = d3.select('#bossier')
        .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
        .append('g')
            .attr('transform',
                  'translate(' + margin.left + ',' + margin.top + ")");
        
    d3.json('bossier.json') // we can actually just use await here
        .then(json=>{
            // format Lab Collection Date
            json.forEach((d,i)=>{
                // we need to strip the last three 0's from Lab Collection Date or we get weird numbers
                d['Lab Collection Date'] = d3.timeParse('%s')(String(d['Lab Collection Date']).slice(0, -3));
                json[i] = d;
            })
            
            let x = d3.scaleTime()
                .domain(d3.extent(json, d=>d['Lab Collection Date']))
                .range([0, width])
            
            bossierSvg.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            let y = d3.scaleLinear()
                // .domain([0, d3.max(json, d=> d['Daily Case Count']/BOSSIER_POP_2019)])
                .domain(yStandard)
                .range([height, 0])
            bossierSvg.append('g')
                .call(d3.axisLeft(y));
            
            // append the line
            bossierSvg.append('path')
                .datum(json)
                .attr('fill', 'none')
                .attr('stroke', '#222')
                .attr('stroke-width', 1.5)
                .attr('d', d3.line()
                    .x(d=>x(d['Lab Collection Date']))
                    .y(d=>y(d['Daily Case Count']/BOSSIER_POP_2019))
                )
                
        })
    
    let caddoHeader = document.createElement('h3');
    caddoHeader.innerText = "Caddo Parish Covid-19 daily cases per capita";
    document.querySelector('#caddo')
            .appendChild(caddoHeader);

    const caddoSvg = d3.select('#caddo')
        .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
        .append('g')
            .attr('transform',
                  'translate(' + margin.left + ',' + margin.top + ")");


    d3.json('caddo.json')
        .then((json=>{
            // format Lab Collection Date
            json.forEach((d,i)=>{
                // we need to strip the last three 0's from Lab Collection Date or we get weird numbers
                d['Lab Collection Date'] = d3.timeParse('%s')(String(d['Lab Collection Date']).slice(0, -3));
                console.log(d);
                json[i] = d;
            })

            let x = d3.scaleTime()
                .domain(d3.extent(json, d=>d['Lab Collection Date']))
                .range([0, width])
            
            caddoSvg.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            let y = d3.scaleLinear()
                // .domain([0, d3.max(json, d=> d['Daily Case Count']/CADDO_POP_2019)])
                .domain(yStandard)
                .range([height, 0])
                caddoSvg.append('g')
                .call(d3.axisLeft(y));
            
            // append the line
            caddoSvg.append('path')
                .datum(json)
                .attr('fill', 'none')
                .attr('stroke', '#222')
                .attr('stroke-width', 1.5)
                .attr('d', d3.line()
                    .x(d=>x(d['Lab Collection Date']))
                    .y(d=>y(d['Daily Case Count']/CADDO_POP_2019))
                )
        }))
})()
*/
</script>